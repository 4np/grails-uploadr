(function(c){var d={playNotification:function(a){if(a.workvars.notificationSoundEffect){a.workvars.notificationSoundEffect.play()}},playError:function(a){if(a.workvars.errorSoundEffect){a.workvars.errorSoundEffect.play()}},playDelete:function(a){if(a.workvars.deleteSoundEffect){a.workvars.deleteSoundEffect.play()}},cancel:function(a){if(a.preventDefault){a.preventDefault();a.stopPropagation()}return false},dragOver:function(a){d.cancel(a)},dragEnter:function(h,b,i,a,j){b.addClass(a);d.cancel(h,b,i,a,j);if(!j.workvars.gotFiles){c(".placeholder",b).hide()}},dragLeave:function(h,b,i,a,j){if(h.target&&h.target==b[0]){b.removeClass(a)}d.cancel(h);c(".placeholder",b).html(j.placeholderText);if(!j.workvars.gotFiles){c(".placeholder",b).show()}},addFile:function(i,b,j){var a=d.addFileElements(i,b,j,false);var h=c(a);d.onProgressHandler(h,b,100,j.labelDone);c(".placeholder",i).hide();j.workvars.gotFiles=true;d.addButtons(b,h,j)},addFileElements:function(x,a,G,u){var J=(G.id+"File"+G.workvars.files.length);var w=document.createElement("div");w.setAttribute("class","file");var y=document.createElement("div");y.setAttribute("class","background");var F=document.createElement("div");F.setAttribute("class","progress");var B=document.createElement("div");B.setAttribute("class","info");var I=document.createElement("div");I.setAttribute("class","details");var b=document.createElement("div");b.setAttribute("class","buttons");var E=document.createElement("div");E.setAttribute("class","spinner");E.style.display="none";var C=document.createElement("div");C.setAttribute("class","name");C.setAttribute("id",J);var v=document.createElement("span");v.setAttribute("class","fileName");v.innerHTML=d.shortenFileName(G.maxFileNameLength,a.fileName);var H=document.createElement("div");H.setAttribute("class","size");H.innerHTML=d.bytesToSize(a.fileSize);var z=document.createElement("div");z.setAttribute("class","percentage");z.innerHTML=((u)?"0%":G.labelDone);var A=document.createElement("div");A.setAttribute("class","speed");B.appendChild(I);B.appendChild(b);B.appendChild(E);C.appendChild(v);I.appendChild(C);I.appendChild(H);I.appendChild(z);I.appendChild(A);w.appendChild(y);w.appendChild(F);w.appendChild(B);var D=c(".files",x)[0];if(G.insertDirection=="down"){D.appendChild(w)}else{D.insertBefore(w,D.childNodes[0])}d.addFileTooltip(c(".fileName",c("#"+J)),a);if(G.insertDirection=="up"){G.workvars.files.unshift(w);if(G.workvars.viewing>0){G.workvars.viewing++}}else{if(!(G.workvars.files.length>0&&G.workvars.viewing<(G.workvars.files.length-1))){G.workvars.viewing=G.workvars.files.length}G.workvars.files.push(w)}d.handlePagination(x,G);return w},removeFileElement:function(b,f){var a=b.parent();d.playDelete(f);b.animate({height:"0px"},200,"swing",function(){for(var e=0;e<f.workvars.files.length;e++){if(f.workvars.files[e]==b.get(0)){f.workvars.files.splice(e,1);break}}if(f.insertDirection=="up"){f.workvars.viewing=(e>0)?e-1:0}else{f.workvars.viewing=(e>(f.workvars.files.length-1))?(f.workvars.files.length-1):e}b.remove();if(c(".info",a).size()<1){c(".placeholder",a).show()}d.handlePagination(f.workvars.uploadrDiv,f)})},handleBadge:function(g,h){h.workvars.uploading+=g;if(h.workvars.uploading<0){h.workvars.uploading=0}var a=h.workvars.badgeDiv,b=h.workvars.uploading;a.html(b);if(b<1&&g<0){a.animate({opacity:0},{duration:1000})}else{if(b==1&&g>0){a.animate({opacity:1},{duration:700})}}},handlePagination:function(A,a){var y,z,v,q,s,r,t,b,w,u=c(".pagination",A),x="",B=a.workvars.files;if(a.maxVisible==0){if(u.is(":visible")){u.hide()}return}if(B.length>a.maxVisible||u.is(":visible")){z=Math.ceil(B.length/a.maxVisible);v=Math.ceil((a.workvars.viewing+1)/a.maxVisible);r=((a.maxVisible*v)-1);s=(r-a.maxVisible+1);for(q=0;q<B.length;q++){y=c(B[q]);if(q<s||q>r){if(y.is(":visible")){y.hide()}}else{if(y.is(":hidden")){y.show()}}}}if(!v||!z||z==1){if(u.is(":visible")){u.hide()}}else{t=a.workvars.prevButton;b=a.workvars.nextButton;w=a.workvars.pagesDiv;if(u.is(":hidden")){u.show()}for(q=1;q<=z;q++){x+="<li"+((q==v)?' class="current"':"")+">"+q+"</li>"}w.html(x);if(v==1){t.hide();b.show()}else{if(v==z){t.show();b.hide()}else{t.show();b.show()}}}},addFileTooltip:function(b,a){b.tipTip({content:"name: "+a.fileName+"<br/>size: "+d.bytesToSize(a.fileSize)+((a.fileDate)?("<br/>date: "+a.fileDate):"")})},drop:function(j,b,l,a,m){var k=j.dataTransfer.files;var n=b;n.removeClass(a);if(j.preventDefault){j.preventDefault();j.stopPropagation()}if(typeof k!=="undefined"){c(".placeholder",b).hide();m.workvars.gotFiles=true;c.each(k,function(h,g){var f={fileName:g.fileName,fileSize:g.fileSize,startTime:new Date().getTime()};var e=d.addFileElements(l,f,m);d.startUpload(g,f,c(e),m)})}return false},startUpload:function(l,k,m,n){var p="";d.handleBadge(1,n);n.onStart(k);if(n.maxSize&&l.fileSize>n.maxSize){return false}var a=new XMLHttpRequest(),o=a.upload,b=c(".progress",m);d.addButton(m,"cancel","cancel.png","click to abort file transfer","are you sure you would like to abort this tranfer?",n,function(e){p="abort";a.abort()});o.addEventListener("progress",function(e){if(n.onProgress(k,m,Math.ceil((e.loaded/e.total)*100))){d.onProgressHandler(m,k,Math.ceil((e.loaded/e.total)*100))}},false);o.addEventListener("error",function(e){d.playError(n);if(n.onProgress(k,m,100)){d.onProgressHandler(m,k,100,n.labelFailed);d.handleBadge(-1,n)}b.addClass("failed")},false);o.addEventListener("abort",function(e){if(n.errorSound){new Audio(n.errorSound).play()}if(n.onProgress(k,m,100)){d.onProgressHandler(m,k,100,n.labelAborted)}b.addClass("failed");n.onAbort(k,m);d.addButton(m,"delete","delete.png","click to remove this aborted transfer from your view","",n,function(){d.removeFileElement(m,n)})},false);a.onreadystatechange=function(){if(a.readyState!=4){return}var f=(a.responseText)?JSON.parse(a.responseText):{};if(f.fileName&&k.fileName!=f.fileName){k.fileName=f.fileName;d.addFileTooltip(c(".fileName",m).html(d.shortenFileName(n.maxFileNameLength,f.fileName)),k)}if(a.status==200){if(n.onProgress(k,m,100)){d.onProgressHandler(m,k,100)}var e=c(".spinner",m);e.show("slow");n.onSuccess(k,m,function(){e.hide();d.onProgressHandler(m,k,100,n.labelDone);d.playNotification(n);d.handleBadge(-1,n);d.addButtons(k,m,n)})}else{d.playError(n);if(n.onProgress(k,m,100)){d.onProgressHandler(m,k,100,n.labelFailed,f.statusText);d.handleBadge(-1,n)}b.addClass("failed");n.onFailure(k,m);if(p!="abort"){n.onDelete(k,m)}return}};a.open("POST",n.uri);a.setRequestHeader("Cache-Control","no-cache");a.setRequestHeader("X-Requested-With","XMLHttpRequest");a.setRequestHeader("X-File-Name",l.fileName);a.setRequestHeader("X-File-Size",l.fileSize);a.setRequestHeader("X-Uploadr-Name",n.id);a.setRequestHeader("Content-Type",l.contentType);a.send(l)},onProgressHandler:function(y,r,a,b,q){var z=y.parent().width();var s=c(".progress",y);var v,p,t,w,x,u;if(r.startTime&&a<100){v=new Date().getTime();p=Math.ceil((v-r.startTime)/1000);t=((r.fileSize/100)*a)/p;if(r.avg){x=Math.round((r.avg+t)/2);r.avg=x}else{r.avg=t;x=t}u=Math.ceil((r.fileSize/x)-p);w=d.bytesToSize(x)+"/s (about "+d.secondsToTime(u)+" to go)"}else{w=""}c(".speed",y).html(w);s.width((z/100)*a);c(".percentage",y).html((b)?b:a+"%");if(b&&q){c(".percentage",y).tipTip({content:q})}if(a>=100){s.addClass("complete");c(".cancel",y).hide();r.speed=null}},addButtons:function(a,b,f){d.addButton(b,"delete","delete.png","click to delete this file","are you sure you want to delete this file?",f,function(){if(f.onDelete(a,b)){d.removeFileElement(b,f)}});d.addButton(b,"download","page_link.png","click to download this file","",f,function(){f.onDownload(a,b)});d.addButton(b,"view","magnifier.png","click to view this file","",f,function(){f.onView(a,b)})},addButton:function(v,p,u,r,s,a,b){var o=document.createElement("div");o.setAttribute("class","button "+p);o.setAttribute("style","display: none");var n=document.createElement("img");n.setAttribute("src",a.famfamfam+"/"+u);o.appendChild(n);var q=c(".buttons",v);q[0].appendChild(o);var t=c("."+p,v);if(r){t.tipTip({content:r})}t.bind("click",function(e){if(!s||(confirm&&confirm(s))){b()}});t.show("slow");return t},bytesToSize:function(f){var a=["B","KB","MB","GB","TB"];if(f==0){return"n/a"}var b=parseInt(Math.floor(Math.log(f)/Math.log(1024)));return Math.round(f/Math.pow(1024,b),2)+" "+a[b]},secondsToTime:function(a){var b=[" seconds","minutes","hours"];if(a==0){return"n/a"}var f=parseInt(Math.floor(Math.log(a)/Math.log(60)));return Math.round(a/Math.pow(60,f),2)+" "+b[f]},shortenFileName:function(j,n){var a="",b="",l="",k=0,m=n.lastIndexOf(".");if(n.length<=j){return n}else{if(m){a=n.substring(0,m);b=n.substring(m+1,n.length);k=(j-4-b.length);if(a.match(/\-\d+$/)){m=a.lastIndexOf("-");l=a.substring(m+1,a.length);a=a.substring(0,m);k-=l.length}}else{a=n}}return a.substring(0,k)+((l)?("..."+l+"."):"....")+b},addFileUploadField:function(b,j,k){var a=document.createElement("input");a.setAttribute("type","file");a.multiple=true;var n=document.createElement("div");n.setAttribute("class","message");n.innerHTML=k.fileSelectText;var l=document.createElement("div");l.setAttribute("class","fileinput");l.appendChild(n);l.appendChild(a);j.appendChild(l);var m=c("input[type=file]",b);c(".message",b).bind("click",function(){m[0].click()});m.bind("change",function(){if(typeof this.files!=="undefined"){c(".placeholder",j).hide();k.workvars.gotFiles=true;c.each(this.files,function(h,g){var f={fileName:g.fileName,fileSize:g.fileSize};var e=d.addFileElements(j,f,k);d.startUpload(g,f,c(e),k)})}})}};c.fn.uploadr=function(b){var a={placeholderText:"drag and drop your files here to upload...",fileSelectText:"Select files to upload",labelDone:"done",labelFailed:"failed",labelAborted:"aborted",dropableClass:"uploadr-dropable",hoverClass:"uploadr-hover",uri:"/upload/uri",id:"uploadr",famfamfam:"/images/icons",maxFileNameLength:34,maxSize:0,maxVisible:5,files:[],uploadField:true,insertDirection:"down",notificationSound:"",errorSound:"",deleteSound:"",workvars:{gotFiles:false,files:[],notificationSoundEffect:null,errorSoundEffect:null,deleteSoundEffect:null,viewing:0,uploading:0,badgeDiv:null,uploadrDiv:null,paginationDiv:null,pagesDiv:null,nextButton:null,prevButton:null},onStart:function(f){},onProgress:function(h,i,j){return true},onSuccess:function(i,j,h){h()},onFailure:function(g,h){return true},onAbort:function(g,h){return true},onView:function(g,h){return true},onDownload:function(g,h){return true},onDelete:function(g,h){return true}};var b=c.extend(a,b);return this.each(function(){var t=c(this);var p=t.get(0);if(b.uploadField){d.addFileUploadField(t,p,b)}var u=document.createElement("div");u.setAttribute("class","badge hidden");var x=document.createElement("div");x.setAttribute("class","placeholder");x.innerHTML=a.placeholderText;var v=document.createElement("div");v.setAttribute("class","files "+a.dropableClass);v.appendChild(x);var e=document.createElement("div");e.setAttribute("class","pagination");var q=document.createElement("div");q.setAttribute("class","previous");var r=document.createElement("div");r.setAttribute("class","pages");var w=document.createElement("div");w.setAttribute("class","next");e.appendChild(q);e.appendChild(r);e.appendChild(w);p.appendChild(u);p.appendChild(v);p.appendChild(e);b.workvars.uploadrDiv=p;b.workvars.badgeDiv=c(u);b.workvars.paginationDiv=c(e);b.workvars.pagesDiv=c(r);b.workvars.nextButton=c(w);b.workvars.prevButton=c(q);b.workvars.badgeDiv.css({opacity:0});b.workvars.paginationDiv.hide();v.addEventListener("dragover",d.dragOver,false);v.addEventListener("dragenter",function(f){d.dragEnter(f,c(this),p,a.hoverClass,b)},false);v.addEventListener("dragleave",function(f){d.dragLeave(f,c(this),p,a.hoverClass,b)},false);v.addEventListener("drop",function(f){d.drop(f,c(this),p,a.hoverClass,b)},false);c(q).bind("click",function(){b.workvars.viewing=b.workvars.viewing-b.maxVisible;d.handlePagination(p,b)});c(w).bind("click",function(){b.workvars.viewing=b.workvars.viewing+b.maxVisible;d.handlePagination(p,b)});d.handlePagination(p,b);if(b.files){for(var s in b.files){d.addFile(p,b.files[s],b)}}if(b.notificationSound){b.workvars.notificationSoundEffect=new Audio(b.notificationSound)}if(b.errorSound){b.workvars.errorSoundEffect=new Audio(b.errorSound)}if(b.deleteSound){b.workvars.deleteSoundEffect=new Audio(b.deleteSound)}})}})(jQuery);