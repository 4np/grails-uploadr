/**
 *  Uploadr, a multi-file uploader plugin
 *  Copyright (C) 2011 Jeroen Wesbeek
 *
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *  http://www.apache.org/licenses/LICENSE-2.0
 *
 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
 */
(function(b){var a={playNotification:function(d){if(d.workvars.notificationSoundEffect){d.workvars.notificationSoundEffect.play()}},playError:function(d){if(d.workvars.errorSoundEffect){d.workvars.errorSoundEffect.play()}},playDelete:function(d){if(d.workvars.deleteSoundEffect){d.workvars.deleteSoundEffect.play()}},cancel:function(d){if(d.preventDefault){d.preventDefault();d.stopPropagation()}return false},dragOver:function(d){a.cancel(d)},dragEnter:function(f,g,e,h,d){g.addClass(h);a.cancel(f,g,e,h,d);if(!d.workvars.gotFiles){b(".placeholder",g).hide()}},dragLeave:function(f,g,e,h,d){if(f.target&&f.target==g[0]){g.removeClass(h)}a.cancel(f);b(".placeholder",g).html(d.placeholderText);if(!d.workvars.gotFiles){b(".placeholder",g).show()}},addFile:function(e,g,d){var h=a.addFileElements(e,g,d,false);var f=b(h);if(g.fileColor){b(".progress",f).css("background-color",g.fileColor)}a.onProgressHandler(f,g,100,d.labelDone,"",d);b(".placeholder",e).hide();d.workvars.gotFiles=true;a.addButtons(g,f,d)},addFileElements:function(s,x,g,v){var d=(g.id+"File"+g.workvars.files.length);var t=document.createElement("div");t.setAttribute("class","file");var r=document.createElement("div");r.setAttribute("class","background");var h=document.createElement("div");h.setAttribute("class","progress");var l=document.createElement("div");l.setAttribute("class","info");var e=document.createElement("div");e.setAttribute("class","details");var w=document.createElement("div");w.setAttribute("class","buttons");var m=document.createElement("div");m.setAttribute("class","voting");var q=document.createElement("div");q.setAttribute("class","controls");q.appendChild(w);q.appendChild(m);var i=document.createElement("div");i.setAttribute("class","spinner");i.style.display="none";var k=document.createElement("div");k.setAttribute("class","name");k.setAttribute("id",d);var u=document.createElement("span");u.setAttribute("class","fileName");u.innerHTML=a.shortenFileName(g.maxFileNameLength,x.fileName);var f=document.createElement("div");f.setAttribute("class","size");f.innerHTML=a.bytesToSize(x.fileSize);var p=document.createElement("div");p.setAttribute("class","percentage");p.innerHTML=((v)?"0%":g.labelDone);var o=document.createElement("div");o.setAttribute("class","rating");var n=document.createElement("div");n.setAttribute("class","speed");l.appendChild(e);l.appendChild(q);l.appendChild(i);k.appendChild(u);e.appendChild(k);e.appendChild(f);e.appendChild(p);e.appendChild(n);e.appendChild(o);t.appendChild(r);t.appendChild(h);t.appendChild(l);var j=b(".files",s)[0];if(g.insertDirection=="down"){j.appendChild(t)}else{j.insertBefore(t,j.childNodes[0])}a.addFileTooltip(b(".fileName",b("#"+d)),x);if(g.insertDirection=="up"){g.workvars.files.unshift(t);if(g.workvars.viewing>0){g.workvars.viewing++}}else{if(!(g.workvars.files.length>0&&g.workvars.viewing<(g.workvars.files.length-1))){g.workvars.viewing=g.workvars.files.length}g.workvars.files.push(t)}a.handlePagination(s,g);x.obj=t;return t},removeFileElement:function(e,d,g,h){var f=e.parent();if(!g){a.playDelete(d)}e.animate({height:"0px"},200,"swing",function(){if(!h){for(var i=0;i<d.workvars.files.length;i++){if(d.workvars.files[i]==e.get(0)){d.workvars.files.splice(i,1);break}}if(d.insertDirection=="up"){d.workvars.viewing=(i>0)?i-1:0}else{d.workvars.viewing=(i>(d.workvars.files.length-1))?(d.workvars.files.length-1):i}}e.remove();if(b(".info",f).size()<1){b(".placeholder",f).show()}a.handlePagination(d.workvars.uploadrDiv,d)})},handleBadge:function(f,d){d.workvars.uploading+=f;if(d.workvars.uploading<0){d.workvars.uploading=0}var h=d.workvars.badgeDiv,g=d.workvars.uploading;h.html(g);var i=(g==1)?d.badgeTooltipSingular:d.badgeTooltipPlural;h.tipTip({content:i.replace("%d",g)});if(g<1&&f<0){h.animate({opacity:0},{duration:1000})}else{if(g==1&&f>0){h.animate({opacity:1},{duration:700});h.unbind("hover")}}if(f<0&&d.workvars.paused.length>0){var e=[];b.each(d.workvars.paused,function(k,l){var j=a.canUpload(d);if(j){a.startUpload(l.file,l.fileAttrs,b(l.fileDiv),d)}else{e.push(l)}});d.workvars.paused=e}},handlePagination:function(e,q){var g,f,j,o,m,n,l,p,i,k=b(".pagination",e),h="",d=q.workvars.files;if(q.maxVisible==0){if(k.is(":visible")){k.hide()}return}if(d.length>q.maxVisible||k.is(":visible")){f=Math.ceil(d.length/q.maxVisible);j=Math.ceil((q.workvars.viewing+1)/q.maxVisible);n=((q.maxVisible*j)-1);m=(n-q.maxVisible+1);for(o=0;o<d.length;o++){g=b(d[o]);if(o<m||o>n){if(g.is(":visible")){g.hide()}}else{if(g.is(":hidden")){g.show()}}}}if(!j||!f||f==1){if(k.is(":visible")){k.hide()}}else{l=q.workvars.prevButton;p=q.workvars.nextButton;i=q.workvars.pagesDiv;if(k.is(":hidden")){k.show()}for(o=1;o<=f;o++){h+="<li"+((o==j)?' class="current"':"")+">"+o+"</li>"}i.html(h);if(j==1){l.hide();p.show()}else{if(j==f){l.show();p.hide()}else{l.show();p.show()}}}},addFileTooltip:function(e,f){var d=new Date();d.setTime(f.fileDate);e.tipTip({content:"name: "+f.fileName+"<br/>size: "+a.bytesToSize(f.fileSize)+((f.fileDate)?("<br/>date: "+d.toString()):""),maxWidth:600})},drop:function(i,j,g,k,f){var h=i.dataTransfer.files;var e=j;e.removeClass(k);if(i.preventDefault){i.preventDefault();i.stopPropagation()}if(typeof h!=="undefined"){b(".placeholder",j).hide();f.workvars.gotFiles=true;var d=[];b.each(h,function(l,m){var o={fileName:((m.name)?m.name:m.fileName),fileSize:((m.size)?m.size:m.fileSize),startTime:new Date().getTime(),fileRating:0,deletable:true};var p=a.addFileElements(g,o,f);var n=b(p);if(a.canUpload(f)){a.startUpload(m,o,n,f)}else{if(f.maxConcurrentUploadsMethod=="pause"){f.workvars.paused.push({file:m,fileAttrs:o,fileDiv:p});a.onProgressHandler(n,m,0,f.labelPaused,"",f)}else{if(f.maxConcurrentUploadsMethod=="cancel"){a.onProgressHandler(n,m,0,f.labelAborted,"",f);var q=f.maxConcurrentUploadsExceeded.replace("%d",f.maxConcurrentUploads);q=q.replace("%a",(f.maxConcurrentUploads==1)?"":"s");q=q.replace("%b",(f.maxConcurrentUploads==1)?" is":"s are");b("div.percentage",n).tipTip({content:q,maxWidth:600});a.addButton(n,"delete",f.removeFromViewText,"",f,function(){a.removeFileElement(n,f)});o.failed=true;b(".progress",n).addClass("failed")}}}})}return false},canUpload:function(d){return(d.maxConcurrentUploads==0||d.workvars.uploading<=d.maxConcurrentUploads)},startUpload:function(f,k,d,n){var h="";a.handleBadge(1,n);n.onStart(k);var m=new XMLHttpRequest(),o=m.upload,j=b(".progress",d);if(n.allowedExtensions.length>0){var e=n.allowedExtensions.split(",");var g=f.name.split(".");var i=g[g.length-1];if(b.inArray(i,e)<0){a.playError(n);if(n.onProgress(k,d,100)){a.onProgressHandler(d,k,100,n.labelInvalidFileExtension,"",n,true);var l=n.fileExtensionNotAllowedText.replace("%s",i);l=l.replace("%s",n.allowedExtensions);b("div.percentage",d).tipTip({content:l,maxWidth:600});a.handleBadge(-1,n);a.addButton(d,"delete",n.removeFromViewText,"",n,function(){a.removeFileElement(d,n)});k.failed=true}j.addClass("failed");return false}}if(n.maxSize&&(((f.fileSize)?f.fileSize:f.size)>n.maxSize)){a.playError(n);if(n.onProgress(k,d,100)){a.onProgressHandler(d,k,100,n.labelFileTooLarge,"",n,true);var l=n.fileTooLargeText.replace("%s",a.bytesToSize(((f.fileSize)?f.fileSize:f.size)));l=l.replace("%s",a.bytesToSize(n.maxSize));b("div.percentage",d).tipTip({content:l,maxWidth:600});a.handleBadge(-1,n);a.addButton(d,"delete",n.removeFromViewText,"",n,function(){a.removeFileElement(d,n)});k.failed=true}j.addClass("failed");return false}a.addButton(d,"cancel",n.fileAbortText,n.fileAbortConfirm,n,function(p){h="abort";m.abort()});o.addEventListener("progress",function(p){if(n.onProgress(k,d,Math.ceil((p.loaded/p.total)*100))){a.onProgressHandler(d,k,Math.ceil((p.loaded/p.total)*100),"","",n)}},false);o.addEventListener("error",function(p){a.playError(n);if(n.onProgress(k,d,100)){a.onProgressHandler(d,k,100,n.labelFailed,"",n,true);a.handleBadge(-1,n)}j.addClass("failed");a.addButton(d,"delete",n.removeFromViewText,"",n,function(){a.removeFileElement(d,n)})},false);o.addEventListener("abort",function(p){a.playError(n);if(n.onProgress(k,d,100)){a.onProgressHandler(d,k,100,n.labelAborted,"",n,true)}j.addClass("failed");n.onAbort(k,d);a.addButton(d,"delete",n.removeFromViewText,"",n,function(){a.removeFileElement(d,n)})},false);m.onreadystatechange=function(){if(m.readyState!=4){return}var p=(m.responseText)?JSON.parse(m.responseText):{};if(p.fileName&&k.fileName!=p.fileName){k.fileName=p.fileName;a.addFileTooltip(b(".fileName",d).html(a.shortenFileName(n.maxFileNameLength,p.fileName)),k)}if(m.status==200){if(n.onProgress(k,d,100)){a.onProgressHandler(d,k,100,"","",n)}var q=b(".spinner",d);q.show("slow");n.onSuccess(k,d,function(){q.hide();a.onProgressHandler(d,k,100,n.labelDone,"",n);a.playNotification(n);a.handleBadge(-1,n);a.addButtons(k,d,n);n.workvars.fileIterator++;n.files[n.workvars.fileIterator]=k},p)}else{a.playError(n);if(n.onProgress(k,d,100)){a.onProgressHandler(d,k,100,n.labelFailed,p.statusText,n);a.handleBadge(-1,n)}j.addClass("failed");n.onFailure(k,d);if(h!="abort"){n.onDelete(k,d)}return}};m.open("POST",n.uri);m.setRequestHeader("Cache-Control","no-cache");m.setRequestHeader("X-Requested-With","Grails Uploadr");m.setRequestHeader("X-File-Name",encodeURIComponent((f.name)?f.name:f.fileName));m.setRequestHeader("X-File-Size",(f.size)?f.size:f.fileSize);m.setRequestHeader("X-Uploadr-Name",encodeURIComponent(n.id));m.setRequestHeader("Content-Type",((f.type)?f.type:f.contentType)+"; charset=utf-8");m.send(f)},onProgressHandler:function(q,i,l,n,g,h,u){var f=q.parent().width();var o=b(".progress",q);var t=b(".percentage",q);var d=b(".speed",q);var j,m,v,r,e,s;if(i.startTime&&l<100){j=new Date().getTime();m=Math.ceil((j-i.startTime)/1000);v=((i.fileSize/100)*l)/m;if(i.avg){e=Math.round((i.avg+v)/2);i.avg=e}else{i.avg=v;e=v}s=Math.ceil((i.fileSize/e)-m);r=a.bytesToSize(e)+"/s (about "+a.secondsToTime(s)+" to go)"}else{r=""}d.html(r);o.width((f/100)*l);t.html((n)?n:l+"%");if(n&&g){t.tipTip({content:g,maxWidth:600})}if(l>=100){var p=b(".rating",q);var k=b(".cancel",q);o.addClass("complete");k.hide();if(h.rating&&!u){d.hide();t.hide(1000,function(){b(this).hide()});a.setRating(i.fileRating,q);p.show(500);if(i.fileRatingText){p.tipTip({content:i.fileRatingText,maxWidth:600})}}i.speed=null}},addVotingButtons:function(f,e,d){if(!d.voting){return true}var i=b(".voting",e);var h=document.createElement("div");h.setAttribute("class","like");var g=document.createElement("div");g.setAttribute("class","unlike");i[0].appendChild(h);i[0].appendChild(g);b(h).bind("click.uploadr",function(){d.onLike(f,e,function(j){f.fileRating=j;if(!f.fileRating||f.fileRating<0){f.fileRating=0}if(f.fileRating>1){f.fileRating=1}a.setRating(f.fileRating,e)})}).tipTip({content:d.likeText,maxWidth:600});b(g).bind("click.uploadr",function(){d.onUnlike(f,e,function(j){f.fileRating=j;if(!f.fileRating||f.fileRating<0){f.fileRating=0}if(f.fileRating>1){f.fileRating=1}a.setRating(f.fileRating,e)})}).tipTip({content:d.unlikeText,maxWidth:600})},addButtons:function(g,f,e){if(g.deletable&&e.deletable){a.addButton(f,"delete",e.fileDeleteText,e.fileDeleteConfirm,e,function(){if(e.onDelete(g,f)){a.removeFileElement(f,e)}})}if(e.colorPicker){var d=a.addButton(f,"color",e.colorPickerText,"",e,function(){var h=b(".progress",f);var i=h.css("background-color");a.launchColorPicker(f,i,e,function(j){h.css("background-color",j);e.onChangeColor(g,f,j)})})}if(e.downloadable){a.addButton(f,"download",e.fileDownloadText,"",e,function(){e.onDownload(g,f)})}if(e.viewable){a.addButton(f,"view",e.fileViewText,"",e,function(){e.onView(g,f)})}a.addVotingButtons(g,f,e)},addButton:function(d,h,g,f,l,k){var j=document.createElement("div");j.setAttribute("class","button "+h);j.setAttribute("style","display: none");var i=b(".buttons",d);i[0].appendChild(j);var e=b("."+h,d);if(g){e.tipTip({content:g,maxWidth:600})}e.bind("click.uploadr",function(m){if(!f||(confirm&&confirm(f))){k()}});e.show("slow");return e},launchColorPicker:function(e,h,u,t){var q=e.parent().parent();var o=b(".pickr",q);var l=null;if(!o.length){var s=document.createElement("div");s.setAttribute("class","arrow");var f=document.createElement("div");f.setAttribute("class","content");var k=document.createElement("ul");for(var j in u.colorPickerColors){var r=document.createElement("li");k.appendChild(r);b(r).css("background-color",u.colorPickerColors[j])}var n=document.createElement("div");n.setAttribute("class","pickr");f.appendChild(k);n.appendChild(f);n.appendChild(s);q[0].appendChild(n);o=b(".pickr",q);o.hide()}var d=b("li",o);for(var j=0;j<d.size();j++){var g=b(d[j]);var m=g.css("background-color");if(m==h){g.addClass("current")}else{g.removeClass("current")}g.unbind("click.uploadr");g.bind("click.uploadr",function(){t(b(this).css("background-color"));b(document).unbind("click.uploadr");o.hide(200)})}var p=e.position();o.css({top:p.top,left:p.left+e.width()+2});o.show(200,function(){b(document).bind("click.uploadr",function(i){if(i.pageX<o.position().left||i.pageX>(o.position().left+o.width())||i.pageY<o.position().top||i.pageY>(o.position().top+o.height())){b(document).unbind("click.uploadr");o.hide(200)}})})},setRating:function(h,f){var m=b(".rating",f);var g=m.children();if(h<0||!h){h=0}if(h>1){h=1}var e=Math.round(h*10);var j=Math.round(e/2);for(var k=1;k<=5;k++){var l=(j>=k)?((j==k&&(e%2))?"half":"full"):"empty";if(g.size()){b(g[k-1])[0].setAttribute("class",l)}else{var d=document.createElement("div");d.setAttribute("class",l);m[0].appendChild(d)}}},bytesToSize:function(d){var f=["B","KB","MB","GB","TB"];if(!d){return"0 B"}var e=parseInt(Math.floor(Math.log(d)/Math.log(1024)));return Math.round(d/Math.pow(1024,e),2)+" "+f[e]},secondsToTime:function(f){var e=[" seconds","minutes","hours"];if(f==0){return"n/a"}var d=parseInt(Math.floor(Math.log(f)/Math.log(60)));return Math.round(f/Math.pow(60,d),2)+" "+e[d]},shortenFileName:function(h,d){var j="",i="",f="",g=0,e=d.lastIndexOf(".");if(d.length<=h){return d}else{if(e){j=d.substring(0,e);i=d.substring(e+1,d.length);g=(h-4-i.length);if(j.match(/\-\d+$/)){e=j.lastIndexOf("-");f=j.substring(e+1,j.length);j=j.substring(0,e);g-=f.length}}else{j=d}}return j.substring(0,g)+((f)?("..."+f+"."):"....")+i},addFileUploadField:function(i,h,g){var k=document.createElement("input");k.setAttribute("type","file");k.multiple=true;var d=document.createElement("div");d.setAttribute("class","message");d.innerHTML=g.fileSelectText;var f=document.createElement("div");f.setAttribute("class","fileinput");f.appendChild(d);f.appendChild(k);h.appendChild(f);var e=b("input[type=file]",i);b(".message",i).bind("click.uploadr",function(){e[0].click()});e.bind("change.uploadr",function(){if(typeof this.files!=="undefined"){b(".placeholder",h).hide();g.workvars.gotFiles=true;b.each(this.files,function(j,l){var m={fileName:(l.name)?l.name:l.fileName,fileSize:(l.size)?l.size:l.fileSize,startTime:new Date().getTime(),fileRating:0,deletable:true};var n=a.addFileElements(h,m,g);a.startUpload(l,m,b(n),g)})}})}};var c=function(f,e,d){this.clear=function(g){var h={sound:true,erase:true};var g=b.extend(h,g);var i=g.sound;b.each(e.files,function(j,k){var l=b(k.obj);if(!k.erased){if(g.erase){if(e.onDelete(k,l)){d.removeFileElement(l,e,!i)}}else{d.removeFileElement(l,e,!i)}i=false;k.erased=true}});b(".file",e.workvars.uploadrDiv).each(function(){d.removeFileElement(b(this),e,!i,true);i=false})}};b.fn.uploadr=function(d){var e={placeholderText:"drag and drop your files here to upload...",fileSelectText:"Select files to upload",fileAbortText:"Click to abort file transfer",fileAbortConfirm:"Are you sure you would like to abort this transfer?",fileDeleteText:"Click to delete this file",fileDeleteConfirm:"Are you sure you want to delete this file?",fileDownloadText:"Click to download this file",fileViewText:"Click to view this file",fileTooLargeText:"The upload size of %s is larger than allowed maximum of %s",fileExtensionNotAllowedText:'You tried to upload a file with extension "%s" while only files with extensions "%s" are allowed to be uploaded',maxConcurrentUploadsExceeded:"Only %d concurrent upload%a allowed, please retry when the other upload%b finished",likeText:"Click to like",unlikeText:"Click to unlike",colorPickerText:"Click to change background color",badgeTooltipSingular:"%d file is still being uploaded...",badgeTooltipPlural:"%d files are still being uploaded...",removeFromViewText:"Click to remove this aborted transfer from your view",labelDone:"done",labelPaused:"paused",labelFailed:"failed",labelAborted:"aborted",labelFileTooLarge:"too large",labelInvalidFileExtension:"invalid",dropableClass:"uploadr-dropable",hoverClass:"uploadr-hover",uri:"/upload/uri",id:"uploadr",maxFileNameLength:34,maxSize:0,maxVisible:5,files:[],uploadField:true,insertDirection:"down",maxConcurrentUploads:0,maxConcurrentUploadsMethod:"cancel",rating:true,voting:true,colorPicker:true,deletable:true,downloadable:true,viewable:true,allowedExtensions:"",notificationSound:"",errorSound:"",deleteSound:"",colorPickerColors:["#bce08a","#00a8e1","#ff6418","#c78cda","#ffcb00","#e70033"],workvars:{gotFiles:false,files:[],notificationSoundEffect:null,errorSoundEffect:null,deleteSoundEffect:null,viewing:0,uploading:0,badgeDiv:null,uploadrDiv:null,paginationDiv:null,pagesDiv:null,nextButton:null,prevButton:null,fileIterator:-1,paused:[]},onStart:function(f){},onProgress:function(h,g,f){return true},onSuccess:function(h,g,i,f){i()},onFailure:function(g,f){return true},onAbort:function(g,f){return true},onView:function(g,f){return true},onDownload:function(g,f){return true},onDelete:function(g,f){return true},onLike:function(g,f,h){h(g.fileRating+0.1)},onUnlike:function(g,f,h){h(g.fileRating-0.1)},onChangeColor:function(h,g,f){return true}};var d=b.extend(e,d);return this.each(function(){var j=b(this);var n=j.get(0);if(j.data("uploadr")){return}if(d.uploadField){a.addFileUploadField(j,n,d)}var i=document.createElement("div");i.setAttribute("class","badge hidden");var f=document.createElement("div");f.setAttribute("class","placeholder");f.innerHTML=e.placeholderText;var h=document.createElement("div");h.setAttribute("class","files "+e.dropableClass);h.appendChild(f);var o=document.createElement("div");o.setAttribute("class","pagination");var m=document.createElement("div");m.setAttribute("class","previous");var l=document.createElement("div");l.setAttribute("class","pages");var g=document.createElement("div");g.setAttribute("class","next");o.appendChild(m);o.appendChild(l);o.appendChild(g);n.appendChild(i);n.appendChild(h);n.appendChild(o);d.workvars.uploadrDiv=n;d.workvars.badgeDiv=b(i);d.workvars.paginationDiv=b(o);d.workvars.pagesDiv=b(l);d.workvars.nextButton=b(g);d.workvars.prevButton=b(m);d.workvars.badgeDiv.css({opacity:0});d.workvars.paginationDiv.hide();h.addEventListener("dragover",a.dragOver,false);h.addEventListener("dragenter",function(p){a.dragEnter(p,b(this),n,e.hoverClass,d)},false);h.addEventListener("dragleave",function(p){a.dragLeave(p,b(this),n,e.hoverClass,d)},false);h.addEventListener("drop",function(p){a.drop(p,b(this),n,e.hoverClass,d)},false);b(m).bind("click.uploadr",function(){d.workvars.viewing=d.workvars.viewing-d.maxVisible;a.handlePagination(n,d)});b(g).bind("click.uploadr",function(){d.workvars.viewing=d.workvars.viewing+d.maxVisible;a.handlePagination(n,d)});a.handlePagination(n,d);if(d.files){for(var k in d.files){a.addFile(n,d.files[k],d);d.workvars.fileIterator=k}}if(d.notificationSound){d.workvars.notificationSoundEffect=new Audio(d.notificationSound)}if(d.errorSound){d.workvars.errorSoundEffect=new Audio(d.errorSound)}if(d.deleteSound){d.workvars.deleteSoundEffect=new Audio(d.deleteSound)}j.data("uploadr",new c(this,d,a))})}})(jQuery);